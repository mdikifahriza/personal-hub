-- Enable UUID extension if not exists
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Tabel Login
CREATE TABLE IF NOT EXISTS public.login (
  password text NOT NULL
);

-- Insert password default only if table is empty
INSERT INTO public.login (password) 
SELECT '12345678'
WHERE NOT EXISTS (SELECT 1 FROM public.login);

-- Tabel untuk menyimpan metadata file
CREATE TABLE IF NOT EXISTS public.files (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  file_name text NOT NULL,
  file_size bigint NOT NULL,
  file_type text,
  file_path text NOT NULL,
  storage_path text,
  bucket_id text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT files_pkey PRIMARY KEY (id)
);

-- Index untuk performa query
CREATE INDEX IF NOT EXISTS idx_files_created_at ON public.files(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_files_bucket_id ON public.files(bucket_id);

-- Tabel Tasks
CREATE TABLE IF NOT EXISTS public.tasks (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title text NOT NULL,
  description text,
  priority text NOT NULL DEFAULT 'medium' CHECK (priority = ANY (ARRAY['high'::text, 'medium'::text, 'low'::text])),
  status text NOT NULL DEFAULT 'pending' CHECK (status = ANY (ARRAY['pending'::text, 'in_progress'::text, 'completed'::text])),
  due_date date,
  completed_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT tasks_pkey PRIMARY KEY (id)
);

-- Tabel Routines
CREATE TABLE IF NOT EXISTS public.routines (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title text NOT NULL,
  time_of_day text NOT NULL,
  days_of_week integer[] NOT NULL,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT routines_pkey PRIMARY KEY (id)
);

-- Tabel Routine Completions (untuk tracking completion)
CREATE TABLE IF NOT EXISTS public.routine_completions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  routine_id uuid NOT NULL,
  completed_at timestamp with time zone DEFAULT now(),
  CONSTRAINT routine_completions_pkey PRIMARY KEY (id),
  CONSTRAINT routine_completions_routine_id_fkey FOREIGN KEY (routine_id) REFERENCES public.routines(id) ON DELETE CASCADE
);

-- Indexes untuk performa tasks & routines
CREATE INDEX IF NOT EXISTS idx_tasks_status ON public.tasks(status);
CREATE INDEX IF NOT EXISTS idx_tasks_due_date ON public.tasks(due_date);
CREATE INDEX IF NOT EXISTS idx_tasks_created_at ON public.tasks(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_routines_is_active ON public.routines(is_active);
CREATE INDEX IF NOT EXISTS idx_routine_completions_routine_id ON public.routine_completions(routine_id);
CREATE INDEX IF NOT EXISTS idx_routine_completions_completed_at ON public.routine_completions(completed_at DESC);

-- Create notes table
CREATE TABLE IF NOT EXISTS public.notes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  color TEXT,
  is_pinned BOOLEAN DEFAULT FALSE,
  is_archived BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for better query performance
CREATE INDEX IF NOT EXISTS idx_notes_pinned ON public.notes(is_pinned DESC);
CREATE INDEX IF NOT EXISTS idx_notes_archived ON public.notes(is_archived);
CREATE INDEX IF NOT EXISTS idx_notes_updated_at ON public.notes(updated_at DESC);

-- Insert dummy data for notes
INSERT INTO public.notes (title, content, color, is_pinned, is_archived) 
SELECT * FROM (VALUES
  ('Meeting Notes', 'Discuss Q1 roadmap with team
- Review marketing strategy
- Plan product launches
- Budget allocation', '#fef68a', TRUE, FALSE),
  ('Shopping List', 'Groceries:
- Milk
- Eggs
- Bread
- Vegetables
- Fruits', '#a7ffeb', FALSE, FALSE)
) AS v(title, content, color, is_pinned, is_archived)
WHERE NOT EXISTS (SELECT 1 FROM public.notes);

-- Create passwords table
CREATE TABLE IF NOT EXISTS public.passwords (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  service TEXT NOT NULL,
  username TEXT NOT NULL,
  password TEXT NOT NULL,
  notes TEXT,
  strength INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create index for better search performance
CREATE INDEX IF NOT EXISTS idx_passwords_service ON public.passwords(service);
CREATE INDEX IF NOT EXISTS idx_passwords_username ON public.passwords(username);
CREATE INDEX IF NOT EXISTS idx_passwords_created_at ON public.passwords(created_at DESC);

-- Insert dummy data for passwords
INSERT INTO public.passwords (service, username, password, notes, strength) 
SELECT * FROM (VALUES
  ('Gmail', 'diki@gmail.com', 'MySecureP@ss123', 'Akun email utama', 85),
  ('Facebook', 'diki.user', 'Fb2024!Strong', 'Akun sosmed pribadi', 80)
) AS v(service, username, password, notes, strength)
WHERE NOT EXISTS (SELECT 1 FROM public.passwords);

-- Create accounts table
CREATE TABLE IF NOT EXISTS public.accounts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('cash', 'bank', 'ewallet', 'credit')),
  currency TEXT DEFAULT 'IDR',
  initial_balance DECIMAL(15, 2) DEFAULT 0,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create categories table
CREATE TABLE IF NOT EXISTS public.categories (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  icon TEXT DEFAULT 'üí∞',
  color TEXT DEFAULT '#3b82f6',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create transactions table
CREATE TABLE IF NOT EXISTS public.transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  amount DECIMAL(15, 2) NOT NULL,
  category_id UUID REFERENCES public.categories(id) ON DELETE CASCADE,
  account_id UUID REFERENCES public.accounts(id) ON DELETE CASCADE,
  description TEXT,
  date DATE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create transfers table
CREATE TABLE IF NOT EXISTS public.transfers (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  from_account UUID REFERENCES public.accounts(id) ON DELETE CASCADE,
  to_account UUID REFERENCES public.accounts(id) ON DELETE CASCADE,
  amount DECIMAL(15, 2) NOT NULL,
  transfer_date DATE NOT NULL,
  note TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create recurring_transactions table
CREATE TABLE IF NOT EXISTS public.recurring_transactions (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  account_id UUID REFERENCES public.accounts(id) ON DELETE CASCADE,
  category_id UUID REFERENCES public.categories(id) ON DELETE CASCADE,
  type TEXT NOT NULL CHECK (type IN ('income', 'expense')),
  amount DECIMAL(15, 2) NOT NULL,
  frequency TEXT NOT NULL CHECK (frequency IN ('daily', 'weekly', 'monthly', 'yearly')),
  next_run DATE NOT NULL,
  description TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create budgets table
CREATE TABLE IF NOT EXISTS public.budgets (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  category_id UUID REFERENCES public.categories(id) ON DELETE CASCADE,
  monthly_limit DECIMAL(15, 2) NOT NULL,
  period TEXT NOT NULL CHECK (period IN ('weekly', 'monthly', 'yearly')),
  start_date DATE NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_transactions_date ON public.transactions(date DESC);
CREATE INDEX IF NOT EXISTS idx_transactions_account ON public.transactions(account_id);
CREATE INDEX IF NOT EXISTS idx_transactions_category ON public.transactions(category_id);
CREATE INDEX IF NOT EXISTS idx_transfers_date ON public.transfers(transfer_date DESC);
CREATE INDEX IF NOT EXISTS idx_recurring_next_run ON public.recurring_transactions(next_run);

-- Insert dummy accounts
INSERT INTO public.accounts (name, type, initial_balance, is_active) 
SELECT * FROM (VALUES
  ('Dompet', 'cash', 500000, TRUE),
  ('BCA', 'bank', 5000000, TRUE),
  ('GoPay', 'ewallet', 200000, TRUE)
) AS v(name, type, initial_balance, is_active)
WHERE NOT EXISTS (SELECT 1 FROM public.accounts);

-- Insert dummy categories
INSERT INTO public.categories (name, type, icon, color) 
SELECT * FROM (VALUES
  ('Gaji', 'income', 'üíº', '#10b981'),
  ('Freelance', 'income', 'üíª', '#3b82f6'),
  ('Makan', 'expense', 'üçî', '#ef4444'),
  ('Transport', 'expense', 'üöó', '#f59e0b'),
  ('Belanja', 'expense', 'üõí', '#8b5cf6'),
  ('Hiburan', 'expense', 'üéÆ', '#ec4899')
) AS v(name, type, icon, color)
WHERE NOT EXISTS (SELECT 1 FROM public.categories);

-- Insert dummy transactions (with proper category and account lookup)
DO $$
DECLARE
  v_gaji_id UUID;
  v_makan_id UUID;
  v_transport_id UUID;
  v_bca_id UUID;
  v_dompet_id UUID;
  v_gopay_id UUID;
BEGIN
  -- Get category IDs
  SELECT id INTO v_gaji_id FROM public.categories WHERE name = 'Gaji' LIMIT 1;
  SELECT id INTO v_makan_id FROM public.categories WHERE name = 'Makan' LIMIT 1;
  SELECT id INTO v_transport_id FROM public.categories WHERE name = 'Transport' LIMIT 1;
  
  -- Get account IDs
  SELECT id INTO v_bca_id FROM public.accounts WHERE name = 'BCA' LIMIT 1;
  SELECT id INTO v_dompet_id FROM public.accounts WHERE name = 'Dompet' LIMIT 1;
  SELECT id INTO v_gopay_id FROM public.accounts WHERE name = 'GoPay' LIMIT 1;
  
  -- Insert only if transactions table is empty
  IF NOT EXISTS (SELECT 1 FROM public.transactions) THEN
    INSERT INTO public.transactions (type, amount, category_id, account_id, description, date) VALUES
    ('income', 5000000, v_gaji_id, v_bca_id, 'Gaji bulan ini', CURRENT_DATE),
    ('expense', 50000, v_makan_id, v_dompet_id, 'Makan siang', CURRENT_DATE),
    ('expense', 25000, v_transport_id, v_gopay_id, 'Ojek online', CURRENT_DATE - 1);
  END IF;
END $$;
